#!/usr/bin/env python3
"""
Script para configurar banco de dados no Railway
UT-SOCIOS - Sistema de Gest√£o de S√≥cios
"""

import os
import sys
import mysql.connector
from mysql.connector import Error

class RailwayDatabaseSetup:
    def __init__(self):
        self.connection = None
        
    def print_header(self, title):
        """Imprimir cabe√ßalho"""
        print(f"\n{'='*60}")
        print(f"üóÑÔ∏è {title}")
        print(f"{'='*60}")
        
    def get_database_config(self):
        """Obter configura√ß√£o do banco"""
        self.print_header("CONFIGURA√á√ÉO DO BANCO DE DADOS")
        
        print("üìù Por favor, forne√ßa as informa√ß√µes do banco MySQL do Railway:")
        print("üí° Voc√™ pode encontrar essas informa√ß√µes na dashboard do Railway")
        print("   Clique no servi√ßo MySQL ‚Üí Aba 'Connect'")
        
        host = input("üè† Host: ").strip()
        database = input("üìä Nome do banco: ").strip()
        user = input("üë§ Usu√°rio: ").strip()
        password = input("üîë Senha: ").strip()
        port = input("üîå Porta (padr√£o 3306): ").strip() or "3306"
        
        return {
            'host': host,
            'database': database,
            'user': user,
            'password': password,
            'port': int(port)
        }
    
    def test_connection(self, config):
        """Testar conex√£o com banco"""
        self.print_header("TESTANDO CONEX√ÉO")
        
        try:
            self.connection = mysql.connector.connect(
                host=config['host'],
                database=config['database'],
                user=config['user'],
                password=config['password'],
                port=config['port'],
                charset='utf8mb4',
                collation='utf8mb4_unicode_ci'
            )
            
            if self.connection.is_connected():
                print("‚úÖ Conex√£o com banco estabelecida com sucesso!")
                return True
            else:
                print("‚ùå Falha na conex√£o com banco")
                return False
                
        except Error as e:
            print(f"‚ùå Erro ao conectar: {e}")
            return False
    
    def create_tables(self):
        """Criar tabelas do sistema"""
        self.print_header("CRIANDO TABELAS DO SISTEMA")
        
        cursor = self.connection.cursor()
        
        # Tabela usuarios
        usuarios_sql = """
        CREATE TABLE IF NOT EXISTS usuarios (
            id INT AUTO_INCREMENT PRIMARY KEY,
            nome VARCHAR(255) NOT NULL,
            email VARCHAR(255) UNIQUE NOT NULL,
            senha VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
        
        # Tabela comandos
        comandos_sql = """
        CREATE TABLE IF NOT EXISTS comandos (
            id INT AUTO_INCREMENT PRIMARY KEY,
            nome VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
        
        # Tabela planos
        planos_sql = """
        CREATE TABLE IF NOT EXISTS planos (
            id INT AUTO_INCREMENT PRIMARY KEY,
            nome VARCHAR(100) NOT NULL,
            valor DECIMAL(10,2) NOT NULL,
            periodicidade ENUM('Mensal', 'Trimestral', 'Anual') NOT NULL,
            beneficios TEXT,
            inclui_camisa BOOLEAN DEFAULT FALSE,
            ativo BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
        
        # Tabela socios
        socios_sql = """
        CREATE TABLE IF NOT EXISTS socios (
            id INT AUTO_INCREMENT PRIMARY KEY,
            nome_completo VARCHAR(255) NOT NULL,
            foto VARCHAR(500),
            cpf VARCHAR(14) UNIQUE NOT NULL,
            data_nascimento DATE NOT NULL,
            email VARCHAR(255) UNIQUE NOT NULL,
            telefone VARCHAR(20) NOT NULL,
            tamanho_camisa ENUM('PP', 'P', 'M', 'G', 'GG', 'XG', 'XXG') NOT NULL,
            comando_id INT,
            plano_id INT,
            data_adesao_plano DATE,
            data_vencimento_plano DATE,
            cep VARCHAR(10),
            endereco VARCHAR(255),
            numero VARCHAR(20),
            complemento VARCHAR(100),
            bairro VARCHAR(100),
            cidade VARCHAR(100),
            estado VARCHAR(2),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (comando_id) REFERENCES comandos(id),
            FOREIGN KEY (plano_id) REFERENCES planos(id)
        )
        """
        
        # Tabela faturas
        faturas_sql = """
        CREATE TABLE IF NOT EXISTS faturas (
            id INT AUTO_INCREMENT PRIMARY KEY,
            socio_id INT NOT NULL,
            comando_id INT NOT NULL,
            valor DECIMAL(10,2) NOT NULL,
            descricao TEXT,
            data_vencimento DATE NOT NULL,
            data_pagamento DATE,
            status ENUM('Pendente', 'Pago', 'Atrasado') DEFAULT 'Pendente',
            forma_pagamento VARCHAR(50),
            comprovante VARCHAR(500),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (socio_id) REFERENCES socios(id),
            FOREIGN KEY (comando_id) REFERENCES comandos(id)
        )
        """
        
        tables = [
            ("usuarios", usuarios_sql),
            ("comandos", comandos_sql),
            ("planos", planos_sql),
            ("socios", socios_sql),
            ("faturas", faturas_sql)
        ]
        
        for table_name, sql in tables:
            try:
                cursor.execute(sql)
                print(f"‚úÖ Tabela '{table_name}' criada com sucesso!")
            except Error as e:
                print(f"‚ùå Erro ao criar tabela '{table_name}': {e}")
        
        cursor.close()
        print("‚úÖ Todas as tabelas foram criadas!")
    
    def insert_initial_data(self):
        """Inserir dados iniciais"""
        self.print_header("INSERINDO DADOS INICIAIS")
        
        cursor = self.connection.cursor()
        
        # Inserir usu√°rio admin
        admin_password = "123"  # Senha padr√£o
        import bcrypt
        hashed_password = bcrypt.hashpw(admin_password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
        
        admin_sql = """
        INSERT IGNORE INTO usuarios (nome, email, senha) 
        VALUES (%s, %s, %s)
        """
        
        try:
            cursor.execute(admin_sql, ("Administrador", "fernando@f5desenvolve.com.br", hashed_password))
            print("‚úÖ Usu√°rio administrador criado!")
            print("   üìß Email: fernando@f5desenvolve.com.br")
            print("   üîë Senha: 123")
        except Error as e:
            print(f"‚ùå Erro ao criar usu√°rio admin: {e}")
        
        # Inserir planos padr√£o
        planos_data = [
            ("Bronze", 30.00, "Mensal", "Acesso b√°sico √†s atividades", False),
            ("Prata", 50.00, "Mensal", "Acesso completo + camisa", True),
            ("Ouro", 80.00, "Mensal", "Acesso premium + benef√≠cios exclusivos", True)
        ]
        
        planos_sql = """
        INSERT IGNORE INTO planos (nome, valor, periodicidade, beneficios, inclui_camisa) 
        VALUES (%s, %s, %s, %s, %s)
        """
        
        try:
            for plano in planos_data:
                cursor.execute(planos_sql, plano)
            print("‚úÖ Planos padr√£o criados!")
        except Error as e:
            print(f"‚ùå Erro ao criar planos: {e}")
        
        # Inserir comando padr√£o
        comando_sql = """
        INSERT IGNORE INTO comandos (nome) 
        VALUES (%s)
        """
        
        try:
            cursor.execute(comando_sql, ("Comando Principal",))
            print("‚úÖ Comando padr√£o criado!")
        except Error as e:
            print(f"‚ùå Erro ao criar comando: {e}")
        
        self.connection.commit()
        cursor.close()
        print("‚úÖ Dados iniciais inseridos com sucesso!")
    
    def generate_env_file(self, config):
        """Gerar arquivo .env para desenvolvimento local"""
        self.print_header("GERANDO ARQUIVO .env")
        
        env_content = f"""# Configura√ß√£o do banco de dados Railway
DB_HOST={config['host']}
DB_NAME={config['database']}
DB_USER={config['user']}
DB_PASSWORD={config['password']}
DB_PORT={config['port']}

# Configura√ß√£o local
# DB_HOST=localhost
# DB_NAME=ut_socios
# DB_USER=root
# DB_PASSWORD=
# DB_PORT=3306
"""
        
        try:
            with open(".env", "w", encoding="utf-8") as f:
                f.write(env_content)
            print("‚úÖ Arquivo .env criado com sucesso!")
            print("üìù Use este arquivo para desenvolvimento local")
        except Exception as e:
            print(f"‚ùå Erro ao criar arquivo .env: {e}")
    
    def show_railway_variables(self, config):
        """Mostrar vari√°veis para configurar no Railway"""
        self.print_header("VARI√ÅVEIS PARA CONFIGURAR NO RAILWAY")
        
        print("""
üîß CONFIGURE ESTAS VARI√ÅVEIS NO RAILWAY:

1. üì± Acesse sua app no Railway
2. ‚öôÔ∏è Clique em "Variables"
3. ‚ûï Adicione as seguintes vari√°veis:

PORT=8501
DB_HOST={host}
DB_NAME={database}
DB_USER={user}
DB_PASSWORD={password}
DB_PORT={port}

üåê SUA APP ESTAR√Å DISPON√çVEL EM:
https://seu-projeto-production.up.railway.app

‚úÖ LOGIN PADR√ÉO:
üìß Email: fernando@f5desenvolve.com.br
üîë Senha: 123
        """.format(**config))
    
    def run_setup(self):
        """Executar configura√ß√£o completa"""
        print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    üóÑÔ∏è RAILWAY DATABASE SETUP               ‚ïë
‚ïë              Configura√ß√£o do banco de dados                 ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        """)
        
        # Obter configura√ß√£o
        config = self.get_database_config()
        
        # Testar conex√£o
        if not self.test_connection(config):
            print("‚ùå N√£o foi poss√≠vel conectar ao banco!")
            return False
        
        try:
            # Criar tabelas
            self.create_tables()
            
            # Inserir dados iniciais
            self.insert_initial_data()
            
            # Gerar arquivo .env
            self.generate_env_file(config)
            
            # Mostrar vari√°veis para Railway
            self.show_railway_variables(config)
            
            print("\nüéä CONFIGURA√á√ÉO CONCLU√çDA COM SUCESSO!")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro durante configura√ß√£o: {e}")
            return False
        
        finally:
            if self.connection and self.connection.is_connected():
                self.connection.close()

def main():
    """Fun√ß√£o principal"""
    setup = RailwayDatabaseSetup()
    success = setup.run_setup()
    
    if success:
        print("\nüéâ Banco de dados configurado! Sua app est√° pronta!")
    else:
        print("\nüí• Falha na configura√ß√£o. Verifique as informa√ß√µes do banco.")

if __name__ == "__main__":
    main()
